---
title: "Lake Ice Phenology"
author: 'FREC 3004: Environmental Informatics'
date: "Spring 2019"
output:
  html_document: default
  word_document: default
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```
# Science question

Are lakes losing ice earlier in the year?


#Learning objectives
- Understand how global climate change impacts local aquatic ecosystems
- Analyze a long-term ice-off dataset with understanding of statistical differences, biological relevance, and sources of variation
- Predict future scenarios of ice-off using linear models
- Develop skills using R for graphing and statistics
- Practice the data science workflow in the context of the Tidyverse.

#Why this matters:  
Lakes are changing worldwide due to altered climate.  Many lakes that were historically frozen in the winter are now experiencing fewer days of ice cover and earlier ice-off dates (or not even freezing at all).  In this module, you will explore long-term ice-off datasets from several lakes and use linear regression to make predictions about ice-off dates in the future.

#Data science workflow

We will be following the data science workflow described in Wickland and Grolemund 2017

##Initate project

First, create a directory structure for this module (i.e., project). 

- Create a folder called `FREC3004_Module1_IcePheno`

Within that folder, create folders for the following

  - `doc`: where you will put text documents associated with the project
  - `data`: where you will put raw data and metadata
  - `results`: where you will save files generated by analysis
  - `src`: where you will save your scripts (i.e., .R or .Rmd files)
  
Save this file in the `FREC3004_Module1_IcePheno` directory

Load the tidyverse
```{r, message = FALSE}
#install.packages("tidyverse")
library(tidyverse)
```

##Import

Download the data file ("lake_ice_phenology_all_lakes.csv") from Canvas (by clicking in Canvas, don't use the download.file function) and move it into your `project_directory/data` directory.  Then use the function `read_csv` to import the comma delinated file into R.  Name the imported data `ice_data`.

```{r}

```

Now look at a preview of the data by just typing the data name (`ice_data`). The 'doy' in `ice_off_doy` stands for 'day of year' and is the day within the year where ice off occured.

```{r}

```

There should be 3 columns and 2,560 rows.

##Tidy the data

We will learn the key skills in the module using a focal lake.  Use the filter function to filter the larger data to only contain the data from Lake Sunapee, a lake in New Hampshire.  The filter function is described on page 45 of Wickham and Grolemund.  Filter the data `ice_data` by the variable `lake_name`

```{r}

```

##Visualize the data

To visualize the data from Lake Sunapee, create an x-y plot with the year (`year`) on the x-axis and the day of year (`ice_off_doy`) on the y-axis.  See Chapter 1 of Wickham and Grolemund and the Data Carpentery module for more details on ploting using `ggplot2`.  Plot the points (`geom_point`) and connect the points with lines (`geom_line`).  Be sure that the title, x-axis and y-axis labels are clearly labeled.

```{r} 
#INSERT CODE
```

##Model and visualize the data

We want to model how the ice-off date is changing through time.  Our approach in this module is to use a simple linear regression.  The `lm` function will estimate the parameters of the y = mx + b linear regression. Use the `lm` function to to predict ice_off_doy as a function (~) of the year for the dataset (a tibble) called `sunapee`.  Name the results of the linear model fit 

```{r}
fit <- lm(ice_off_doy ~ year, data = sunapee)
```

Then use the function `summary` to explore the result of the lm function

```{r}
summary(fit)
```
If the results of your linear model is an object named `fit`, you can find the regression coefficients at `fit$coefficients[1]` (the intercept) and `fit$coefficients[2]` (the slope).Confirm that `fit$coefficients[1]` and `fit$coefficients[2]` match the values expected from the summary

```{r}
fit$coefficients[1]
fit$coefficients[2]
```

It is important that the residuals from our linear model are normally distributed.  We will use a histogram to visually assess whether this requirement is met.  First, you will need to calculate the residuals.  Second, you wll need to use  `geom_histogram` to plot the histogram.  I recommend using a binwidth of 5 in the histogram. 

```{r}
sunapee <- sunapee %>% 
  mutate(predicted = fit$coefficients[1] + year * fit$coefficients[2], 
         residual = ice_off_doy - predicted) #Observed - Predicted

ggplot(data = sunapee) +
  geom_histogram(aes(x = resid), binwidth = 5)
```

Now plot the data for Lake Sunapee (just like above - year vs. ice of doy) but add the results for your regression.  You will use the `geom_abline` function. 

```{r}

```

Now use the regression line to predict the ice-off day of year in 2019.  First, use the regression coefficients with the year 2019 to calculate the ice-off day using the linear relationship (y = mx + b)

```{r}
#INSERT CODE
```

##Transform, model, and visualze the data

Create two regression lines that represent a breakpoint in 1970 for the regression.  First, create a new variable in your data frame that labels a datapoint as being before or after the breakpoint  You will use the `mutate` function with the `ifelse` function within mutate to create and add the new variable to the data frame `sunapee` 

```{r}
#INSERT CODE
```

Second, create two different datasets: One for pre 1970 and one for equal to or greater than 1970.  You will use the `filter` function. 

```{r}
#INSERT CODE
```

Third, calculate the regression sepearately for the two time periods. 

```{r}
#INSERT CODE
```

Fourth, examine the linear regressions.  How do the coefficients differ and R2 differ between the two time periods? 

```{r}
#INSERT CODE
```


```{r}
#INSERT CODE
```

Fifth, compare confidence intervals for the coefficients to see if they overlap.  If the 95% confidence interval for the slope overlap then we can say that the slope is statistically different between the two time periods.  Use the function `confint()` to estimate the confidence intervals for the two regressions. Do the slopes overlap?

```{r}
#INSERT CODE
```

Finally, add a regression line from the earliest year until 1970, and then add the second regression line from 1970 to the present to the ice-off vs. year plot.  Then use `ggsave("/results/plot.pdf", width = 7, height = 5)` to save your plot. You will need to complete the code below.

```{r}
ggplot(data = sunapee) +
  geom_point(mapping = aes(x = year, y = ice_off_doy, color = break_point)) + 
  geom_abline(mapping = aes(intercept = fit_lt1970$coefficients[1],
              slope = fit_lt1970$coefficients[2]), 
              color = "blue") + 
  
  ### Add the code that adds the second regression line 
  ### (same as the geom_abline but with different slope and intercept)
  
  scale_colour_manual(name = "Time Period",
                      values=c("black","blue"), 
                      labels = c("Post 1970","Pre 1970")) +
  labs(title ="Lake Sunapee", 
       x = "Year", 
       y = "Ice-off Day of Year")
ggsave("results/plot.pdf", width = 7, height = 5)
```

Predict the ice-off day in 2019 using the two different regressions. How do your results depend on the time period used to create your model?

```{r}
#INSERT CODE
```
##Next Steps

Focus only on the following 7 lakes: Baikal, Cazenovia, Mendota, Monona, Oneida, Sunapee, Wingra

**Question 1:** Make a figure using the facet capacity to create separate panels for each lake. The figure must include the regression line for each lake using  `geom_smooth(method = "lm", se=FALSE, color="blue", formula =  y ~ x)`. Be sure that the x and y are defined as aes with the ggplot function call.  The figure must be clearly labeled (x axis, y axis, title, axis units).  See labs() function above.

**Answer 1:**
```{r}

```

**Question 2:** Describe your figure using a 1-2 sentence figure caption. 

Writing a concise figure caption is an important scientific skill. Peruse scientific literature for examples of figure captions, such as the Magnuson et al. 2000 paper (see Canvas). Be brief! The first sentence of the caption can also be considered a title. If you use abbreviations in the axis label, you must define it in caption. Do not include the ‘why’ in a figure caption; only describe the ‘what.’  

**Answer 2:**

**Question 3:**  Which lake is showing the most change in the ice-off day of year? Which is showing the least change in the ice-off day of year? (use separate linear regressions to calculate the different slopes)

**Answer 3:**

```{r}
 

```

**Question 4:** Is the change in ice-off day (i.e., slope of regression) related to any of the characteristics (latitude, lake area, or tropic status) included in the power point presentation?

**Answer 4:**

```{r}


```

**Question 5:** What is the predicted ice-off day for the lake with the largest slope in 2018 and 2050?  How many days earlier is ice-off predicted to occur? Be sure that your predictions are print out to the Knited document.  


**Answer 5:**
```{r}


```

**Question 6:** If you were to report this prediction to a lake manager, what caveats about this prediction would you also provide?

**Answer 6**:


**Question 7:**  Revisit your analysis code and the set of functions that you used.  Assign each of the functions that you used to the most appropriate component of the data science workflow (Data Science workflow in Wickland and Grolemund 2017, page ix)

**Answer 7:**
Import:

Tidy:

Transform:

Model:

Visualize:

Communicate:

##Citation

This module was initially developed as a Excel-based activity by Carey, C.C., J.L. Klug, and D.C. Richardson. 1 April 2015. Project EDDIE: Lake Ice Phenology. Project EDDIE Module 1, Version 1: http://cemast.illinoisstate.edu/data-for-students/modules/ice-phenology.shtml. Module development was supported by NSF DEB 1245707.
